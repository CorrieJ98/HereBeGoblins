[gd_scene load_steps=12 format=3 uid="uid://c1s74p02pwuum"]

[ext_resource type="Script" path="res://scene/global/game_controller.gd" id="1_vye5u"]
[ext_resource type="PackedScene" uid="uid://deqmu1hpifyyb" path="res://scene/levels/debug_environment.tscn" id="3_njckj"]
[ext_resource type="Script" path="res://scene/global/profile_unit.gd" id="4_4seaa"]
[ext_resource type="PackedScene" uid="uid://37ey3tfm5syb" path="res://scene/structures/town_hall.tscn" id="4_mnd0u"]
[ext_resource type="PackedScene" uid="uid://cq7kgdky61uue" path="res://scene/units/beastmaster.tscn" id="5_givmo"]
[ext_resource type="PackedScene" uid="uid://btjdrk2e273lo" path="res://scene/units/goblin.tscn" id="6_u1tw2"]
[ext_resource type="PackedScene" uid="uid://bna3ueht5drf5" path="res://scene/units/naked_peasant.tscn" id="7_2hlv1"]
[ext_resource type="Resource" uid="uid://j20v8b1136d" path="res://resources/profiles/naked_peasant_prof.tres" id="7_hsryn"]
[ext_resource type="Script" path="res://scene/global/UI/ui.gd" id="8_jcynk"]

[sub_resource type="Resource" id="Resource_fpqho"]
resource_local_to_scene = true
resource_name = "Beastmaster"
script = ExtResource("4_4seaa")
name = "Beastmaster"
rank = 1
unit_type = 0
unit_subtype = 1
max_health = 15
current_health = 15
speed_walk = 64
base_atk_dmg = 2
base_attack_speed = 2.0
line_of_sight = 1000
agro_range = 150
library_name_idle = "beastmaster-anim-idle"
library_name_move = "beastmaster-anim-move"
library_name_attack = "beastmaster-anim-attack"
library_name_death = ""
library_names_corpse = Array[String]([])
basic_abilties = Array[int]([])
special_abilities = Array[int]([1])
traits = Array[int]([0, 2])

[sub_resource type="GDScript" id="GDScript_olaer"]
script/source = "class_name _SelectionBox extends Panel

var mousePos = Vector2()
var mousePosGlobal = Vector2()
var start = Vector2()
var startV = Vector2()
var end = Vector2()
var endV = Vector2()
var is_dragging : bool = false

signal area_selected(box)
signal select_unit(profile)

func _ready() -> void:
	pass

# TODO Rework selection entirely: This should be a rect, it should pass a signal
# to all relevant objects (units and buildings) on the screen that, if they are
# within the borders of the selectionbox, their is_selected bool shall be truthy
# Issue #28

func draw_area(isSelecting : bool = true):
	size = Vector2(abs(startV.x - endV.x), abs(startV.y - endV.y))
	var pos = Vector2()
	pos.x = min(startV.x,endV.x)
	pos.y = min(startV.y, endV.y)
	position = pos
	size *= int(isSelecting)

func box_dragging() -> void:
	if Input.is_action_just_pressed(\"LeftMouseButton\"):
		start = get_viewport().get_mouse_position()
		startV = get_viewport().get_mouse_position()
		is_dragging = true
	if is_dragging:
		end = get_viewport().get_mouse_position()
		endV = get_viewport().get_mouse_position()
		draw_area()
	if Input.is_action_just_released(\"LeftMouseButton\"):
		if startV.distance_to(mousePos) > 20:
			end = get_viewport().get_mouse_position()
			endV = get_viewport().get_mouse_position()
			is_dragging = false
			draw_area(false)
			emit_signal(\"area_selected\",self)
		else:
			end = start
			is_dragging = false
			draw_area(false)

func _input(event) -> void:
	if event is InputEventMouse:
		mousePos = event.position

func _process(delta) -> void:
	box_dragging()
"

[node name="MainScene" type="Node"]
script = ExtResource("1_vye5u")

[node name="Level" type="Node" parent="."]

[node name="DebugEnvironment" parent="Level" instance=ExtResource("3_njckj")]
position = Vector2(-10, -2)

[node name="Buildings" type="Node" parent="Level"]

[node name="TownHall" parent="Level/Buildings" groups=["building_group_"] instance=ExtResource("4_mnd0u")]
position = Vector2(1015, 19)

[node name="Units" type="Node" parent="Level"]

[node name="Beastmaster" parent="Level/Units" groups=["unit_group_"] instance=ExtResource("5_givmo")]
position = Vector2(231, 83)
profile = SubResource("Resource_fpqho")

[node name="NakedPeasant" parent="Level/Units" groups=["unit_group_"] instance=ExtResource("7_2hlv1")]
position = Vector2(75, 68)
profile = ExtResource("7_hsryn")

[node name="Goblin" parent="Level/Units" groups=["unit_group_"] instance=ExtResource("6_u1tw2")]
position = Vector2(560, 384)

[node name="RTS" type="Node" parent="."]
script = ExtResource("1_vye5u")

[node name="Camera2D" type="Camera2D" parent="RTS"]
editor_draw_drag_margin = true

[node name="UI" type="CanvasLayer" parent="RTS"]
script = ExtResource("8_jcynk")

[node name="SelectionBox" type="Panel" parent="RTS/UI"]
anchors_preset = 8
anchor_left = 0.5
anchor_top = 0.5
anchor_right = 0.5
anchor_bottom = 0.5
offset_left = -800.0
offset_top = -450.0
offset_right = -800.0
offset_bottom = -450.0
grow_horizontal = 2
grow_vertical = 2
script = SubResource("GDScript_olaer")

[connection signal="area_selected" from="RTS/UI/SelectionBox" to="." method="_on_area_selected"]
[connection signal="select_unit" from="RTS/UI/SelectionBox" to="." method="_on_unit_selected"]
[connection signal="select_unit" from="RTS/UI/SelectionBox" to="RTS/UI" method="_on_select" unbinds=1]
